# UEFI 与 BIOS 在引导机制上的根本差异

本文档详细对比了 UEFI 和 BIOS 两种引导机制的根本差异，帮助理解现代引导系统与传统引导系统的区别。

---

**重要说明：** 上述设计模式（固定大小、固定地址、实模式等）**仅适用于 BIOS 模式**。UEFI 采用了完全不同的引导机制，从根本上避免了这些限制。

**UEFI 引导机制：**

1. **不使用引导扇区**：
   - UEFI **不使用** 512 字节的 MBR 引导扇区
   - UEFI 使用 **EFI 系统分区（ESP）**，这是一个 FAT32 文件系统分区
   - 引导加载程序是标准的 **PE 格式可执行文件**（.efi），大小不受限制

2. **文件系统引导**：
   - UEFI 固件内置文件系统驱动（支持 FAT12/16/32）
   - 直接从文件系统读取引导加载程序（如 `\EFI\BOOT\BOOTX64.EFI`）
   - 不需要手动解析磁盘扇区

3. **保护模式/长模式启动**：
   - **UEFI 固件本身已经在保护模式（32位）或长模式（64位）下运行**
   - **UEFI 不使用实模式**，引导加载程序直接以保护模式/长模式启动
   - 无需模式切换，无需启用 A20 地址线

4. **统一接口（EFI 服务）**：
   - 不通过 INT 指令调用硬件服务
   - 使用 **EFI 服务**（函数调用接口）
   - 提供统一的硬件抽象层（HAL）

5. **参数传递**：
   - 通过栈传递参数（EFI_HANDLE, EFI_SYSTEM_TABLE）
   - 不依赖寄存器传递启动信息

**UEFI vs BIOS 引导对比：**

| 特性 | BIOS 模式 | UEFI 模式 |
|------|----------|-----------|
| **引导扇区** | 512 字节 MBR，固定地址 0x7C00 | 无引导扇区，使用文件系统 |
| **引导加载程序格式** | 原始二进制代码 | PE 格式可执行文件（.efi） |
| **初始运行模式** | 实模式（16 位） | 保护模式（32 位）或长模式（64 位） |
| **模式切换** | 需要（real_to_prot） | 不需要 |
| **A20 地址线** | 需要手动启用 | 已启用 |
| **GDT/IDT** | 需要手动设置 | 已由 UEFI 设置 |
| **硬件访问** | 通过 INT 指令调用 BIOS 服务 | 通过 EFI 服务（函数调用） |
| **文件系统** | 引导加载程序需要自己实现 | UEFI 内置文件系统驱动 |
| **代码大小限制** | 512 字节（引导扇区） | 无限制（标准可执行文件） |
| **参数传递** | 通过寄存器（%edx = 启动驱动器） | 通过栈（EFI_HANDLE, EFI_SYSTEM_TABLE） |

**UEFI 引导流程：**

```
1. UEFI 固件启动（保护模式/长模式）
   ├─ 初始化硬件
   ├─ 加载 EFI 系统分区（ESP）
   └─ 查找引导加载程序（\EFI\BOOT\BOOTX64.EFI）
    ↓
2. UEFI 加载引导加载程序（PE 格式）
   ├─ 解析 PE 文件格式
   ├─ 加载到内存（任意地址）
   └─ 传递 EFI_HANDLE 和 EFI_SYSTEM_TABLE
    ↓
3. 引导加载程序执行（保护模式/长模式）
   ├─ 直接调用 EFI 服务（无需 INT 指令）
   ├─ 读取配置文件（通过文件系统）
   ├─ 加载内核镜像
   └─ 调用 ExitBootServices() 退出 UEFI 环境
    ↓
4. 跳转到内核（保护模式/长模式）
   └─ 内核继续在保护模式/长模式下运行
```

**为什么 UEFI 不使用实模式？**

1. **现代设计**：UEFI 设计于 2000 年代，直接面向现代 CPU（支持保护模式和长模式）
2. **固件实现**：UEFI 固件本身就在保护模式/长模式下运行，没有实模式阶段
3. **性能考虑**：保护模式/长模式提供更好的内存管理和性能
4. **安全性**：保护模式提供内存保护，提高系统安全性
5. **兼容性**：现代硬件（64 位 CPU）主要使用长模式，实模式主要用于兼容性

**总结：**

- **BIOS 模式**：必须遵循 512 字节引导扇区的限制，从实模式启动，需要手动切换到保护模式
- **UEFI 模式**：完全不同的机制，使用文件系统和标准可执行文件，直接在保护模式/长模式下运行，**不使用实模式**

因此，上述引导扇区程序的设计模式（固定大小、固定地址、实模式等）**仅适用于 BIOS 模式**，UEFI 模式采用了更现代、更灵活的引导机制。

